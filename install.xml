<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http
://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>

		<title lang="en">Invite A Friend</title>
		<description lang="en">Invite A Friend is a phpBB3 Modification, which adds referral and invitation features to the phpBB board in order to have more control over the user registration process and increase the number of users.

			This can either be accomplished by specifying a referral user or sending out invitations with an invitation code attached. The invitation code cannot only be required to make your board private but also helps to associate new users with their referrer adding a more social component to the phpBB board. Supporting Ultimate Points and Cash Mod.</description>
		<author-notes lang="en">Update instructions from previous releases can be found within the contrib/updates folder.
			For further information and bug reports please visit <![CDATA[http://www.phpbb.com/community/viewtopic.php?f=70&t=1224005]]>
		</author-notes>

		<author-group>
			<author>
				<realname>J. Jacoby</realname>
				<email>bycoja@web.de</email>
				<username>Bycoja</username>
				<homepage><![CDATA[http://www.jjacoby.de]]></homepage>
				<contributions-group>
					<contributions status="current" position="Developer" />
				</contributions-group>		
			</author>
		</author-group>

		<mod-version>0.7.0</mod-version>

		<installation>
			<level>intermediate</level>
			<time>1500</time>
			<target-version>3.0.10</target-version>
		</installation>

		<history>
			<entry>
				<date>2012-08-11</date>
				<rev-version>0.7.0 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Referral features </change>
					<change>[Added] Referral template</change>
					<change>[Added] Multiple recipients</change>
					<change>[Added] Statistics</change>
					<change>[Added] Invitation icon</change>
					<change>[Added] More settings (expiration time, post requirement, etc.)</change>
					<change>[Added] ACP Module: Referral settings</change>
					<change>[Added] ACP Module: Overview</change>
					<change>[Changed] Moved the invitation link</change>
					<change>[Changed] Disabled the 'prevent abuse' setting by default</change>
					<change>[Changed] Disabled the options when composing invitations by default</change>
					<change>[Changed] Key generation</change>
					<change>[Fixed] UMIL installation</change>
					<change>[Fixed] Errors when installing with AutoMOD 1.0</change>
					<change>[Fixed] Apply template changes made in the ACP correctly</change>
					<change>[Fixed] Special characters in templates</change>
					<change>[Fixed] Confirmation code display</change>
				</changelog>
			</entry>
			<entry>
				<date>2010-04-19</date>
				<rev-version>0.6.1 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] MOD version check support</change>
					<change>[Added] Turkish translation (thanks to muiketi)</change>
					<change>[Added] Possibility to transfer existing data from 0.5.4 and previous versions and make them work with new releases</change>
					<change>[Fixed] Statistics while viewing group pages</change>
					<change>[Fixed] Disable the invitation class correctly while installing</change>
					<change>[Fixed] Unnecessary include of AutoMOD files in the installation file</change>
					<change>[Fixed] Memberlist colspan</change>
					<change>[Fixed] Correct handling when changing the language while registering</change>
					<change>[Fixed] SQL error when adding new bots</change>
					<change>[Fixed] Missing language var</change>
					<change>[Fixed] Mistakes in modx files</change>
				</changelog>
			</entry>
			<entry>
				<date>2010-04-02</date>
				<rev-version>0.6.0 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Advanced profile statistics (percent of total invitations, etc.)</change>
					<change>[Added] Search for specific actions within the invitation log</change>
					<change>[Added] Display statistics in memberlist</change>
					<change>[Added] Search for members by invitation related criteria</change>
					<change>[Added] Log administrator actions for the invitation log</change>
					<change>[Added] Advanced limitation options</change>
					<change>[Added] Invitation mail priority settings</change>
					<change>[Added] Advanced invitation language settings</change>
					<change>[Added] Templates module in the ACP</change>
					<change>[Added] Templates for subjects</change>
					<change>[Added] List of possible wildcards in templates</change>
					<change>[Added] Turkish translation (thanks to muiketi)</change>
					<change>[Added] AutoMOD support</change>
					<change>[Added] Unified MOD Install Library (UMIL) support</change>
					<change>[Changed] List of invited users in profile has been removed as you can search for members now</change>
					<change>[Improved] Translations for better understanding</change>
					<change>[Improved] Show queue time in the related error message</change>
					<change>[Improved] Show invitation limit in the related error message</change>
					<change>[Improved] Invitation form looks more appealing now</change>
					<change>[Improved] Database queries to increase performance</change>
					<change>[Fixed] Encode usernames in the registration url</change>
					<change>[Fixed] Disable the whole modification will actually disable it now</change>
					<change>[Fixed] Identify users-to-be related to invitations by e-mail-addresses</change>
					<change>[Fixed] Search for specific username in the invitation log</change>
					<change>[Fixed] Mutated vowels in e-mails</change>
					<change>[Fixed] Display an error if the invitation could not be sent</change>
				</changelog>
			</entry>
			<entry>
				<date>2009-11-28</date>
				<rev-version>0.5.4 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Usage of cookies</change>
					<change>[Added] Profile field: "Invited by"</change>
					<change>[Added] Autohide key input field</change>
					<change>[Added] Extended group options</change>
					<change>[Fixed] User in the same group twice</change>
				</changelog>
			</entry>
			<entry>
				<date>2009-11-24</date>
				<rev-version>0.5.3 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Ultimate Points support</change>
					<change>[Added] Identify invited users by e-mail address</change>
					<change>[Added] Several checks for unexpected cases</change>
					<change>[Changed] Improved key generation</change>
					<change>[Changed] Code cleanup</change>
					<change>[Changed] MOD description</change>
					<change>[Fixed] Broken CAPTCHAs</change>
					<change>[Fixed] Template system</change>
				</changelog>
			</entry>
			<entry>
				<date>2009-05-20</date>
				<rev-version>0.5.2 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Add users, who enter a registration key, to the selected group</change>
					<change>[Changed] Create registration keys (even if keys are disabled) to identify friends</change>
					<change>[Changed] Removed constant 'REGISTER_KEY_DISABLED'</change>
					<change>[Fixed] Report #020: Messenger vars not parsed in PM</change>
					<change>[Fixed] Report #019: Missing language vars</change>
					<change>[Fixed] Report #018: E-mail already taken</change>
					<change>[Fixed] Report #016: CAPTCHA</change>
					<change>[Fixed] Report #016: function install(), messages</change>
					<change>[Fixed] Report #015: function install(), permissions</change>
				</changelog>
			</entry>
			<entry>
				<date>2009-04-12</date>
				<rev-version>0.5.1 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Account activation</change>
					<change>[Added] Limitation: Topics</change>
					<change>[Added] Automatically create sql tables, install permissions, ...</change>
					<change>[Added] Automatically add messages referring to installed languages</change>
					<change>[Fixed] Report #013: COPPA Bug</change>
				</changelog>
			</entry>
			<entry>
				<date>2009-04-08</date>
				<rev-version>0.5.0 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Compatibility with 'Advanced Points System'</change>
					<change>[Added] Many options (CAPTCHA, Limitation, ..)</change>
					<change>[Improved] Rewrote some code</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-10-10</date>
				<rev-version>0.2.2 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Compatibility with 'Cash Mod'</change>
					<change>[Added] Highly improved log</change>
					<change>[Added] UCP Module</change>
					<change>[Fixed] Report #009: [phpBB Debug] Undefined variable: new_user_row</change>
					<change>[Fixed] Report #008: [phpBB Debug] Undefined variable: invitation_data</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-10-06</date>
				<rev-version>0.2.1 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Optional registration-key</change>
					<change>[Added] Prohibit multiple registrations</change>
					<change>[Fixed] Report #007: Empty {USERNAME}</change>
					<change>[Fixed] Report #006: Missing var</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-10-05</date>
				<rev-version>0.2.0 [Beta]</rev-version>
				<changelog lang="en">
					<change>[Added] Confirmation e-mail</change>
					<change>[Added] New settings</change>
					<change>[Added] Log</change>
					<change>[Fixed] Report #005: Invite yourself</change>
					<change>[Fixed] Report #004: phpBB Debug</change>
					<change>[Fixed] Report #003: ACP: Edit Mail</change>
					<change>[Fixed] Report #002: 'Invite a friend' shown in navigation</change>
					<change>[Fixed] Report #001: Registration-keys</change>
				</changelog>
			</entry>
		</history>

		<link-group>
			<link type="language" href="contrib/languages/de.xml" lang="en">German Language</link>
			<link type="template" href="contrib/templates/subsilver2.xml" lang="en">Subsilver2</link>
		</link-group>
	</header>

	<action-group>
		<copy>
			<file from="root/includes/functions_invite.php" to="includes/functions_invite.php" />
			<file from="root/includes/acp/info/acp_invite.php" to="includes/acp/info/acp_invite.php" />
			<file from="root/includes/acp/acp_invite.php" to="includes/acp/acp_invite.php" />
			<file from="root/includes/ucp/info/ucp_invite.php" to="includes/ucp/info/ucp_invite.php" />
			<file from="root/includes/ucp/ucp_invite.php" to="includes/ucp/ucp_invite.php" />
			<file from="root/adm/mods/invite_check_version.php" to="adm/mods/invite_check_version.php" />
			<file from="root/adm/style/acp_invite.html" to="adm/style/acp_invite.html" />
			<file from="root/adm/style/acp_invite_overview.html" to="adm/style/acp_invite_overview.html" />
			<file from="root/adm/style/acp_invite_referral.html" to="adm/style/acp_invite_referral.html" />
			<file from="root/adm/style/acp_invite_log.html" to="adm/style/acp_invite_log.html" />
			<file from="root/adm/style/acp_invite_templates.html" to="adm/style/acp_invite_templates.html" />
			<file from="root/styles/prosilver/template/ucp_invite_invite.html" to="styles/prosilver/template/ucp_invite_invite.html" />
			<file from="root/styles/prosilver/template/autosuggest.js" to="styles/prosilver/template/autosuggest.js" />
			<file from="root/styles/prosilver/theme/autosuggest.css" to="styles/prosilver/theme/autosuggest.css" />
			<file from="root/styles/prosilver/theme/images/as_pointer.gif" to="styles/prosilver/theme/images/as_pointer.gif" />
			<file from="root/styles/prosilver/theme/images/hl_corner_bl.gif" to="styles/prosilver/theme/images/hl_corner_bl.gif" />
			<file from="root/styles/prosilver/theme/images/hl_corner_br.gif" to="styles/prosilver/theme/images/hl_corner_br.gif" />
			<file from="root/styles/prosilver/theme/images/hl_corner_tl.gif" to="styles/prosilver/theme/images/hl_corner_tl.gif" />
			<file from="root/styles/prosilver/theme/images/hl_corner_tr.gif" to="styles/prosilver/theme/images/hl_corner_tr.gif" />
			<file from="root/styles/prosilver/theme/images/ul_corner_bl.gif" to="styles/prosilver/theme/images/ul_corner_bl.gif" />
			<file from="root/styles/prosilver/theme/images/ul_corner_br.gif" to="styles/prosilver/theme/images/ul_corner_br.gif" />
			<file from="root/styles/prosilver/theme/images/ul_corner_tl.gif" to="styles/prosilver/theme/images/ul_corner_tl.gif" />
			<file from="root/styles/prosilver/theme/images/ul_corner_tr.gif" to="styles/prosilver/theme/images/ul_corner_tr.gif" />
			<file from="root/language/en/mods/info_acp_invite.php" to="language/en/mods/info_acp_invite.php" />
			<file from="root/language/en/mods/info_ucp_invite.php" to="language/en/mods/info_ucp_invite.php" />
			<file from="root/language/en/email/confirm_subject.txt" to="language/en/email/confirm_subject.txt" />
			<file from="root/language/en/email/confirm_message.txt" to="language/en/email/confirm_message.txt" />
			<file from="root/language/en/email/invite_subject.txt" to="language/en/email/invite_subject.txt" />
			<file from="root/language/en/email/invite_message.txt" to="language/en/email/invite_message.txt" />
			<file from="root/language/en/email/referral_subject.txt" to="language/en/email/referral_subject.txt" />
			<file from="root/language/en/email/referral_message.txt" to="language/en/email/referral_message.txt" />
			<file from="root/install/install_invite.php" to="install/install_invite.php" />
			<file from="root/umil/*.*" to="umil/*.*" />
			<file from="root/referral_as.php" to="referral_as.php" />
		</copy>

		<open src="memberlist.php">
			<edit>
				<find><![CDATA[		// Inactive reason/account?]]></find>
				<action type="before-add"><![CDATA[		if (!class_exists('invite'))
		{
			include($phpbb_root_path . 'includes/functions_invite.' . $phpEx);
		}
		$invite	= new invite();
		$invite_row = $invite->profile_fields(array(), $user_id);
		$template->assign_vars($invite_row);]]></action>
			</edit>
			<edit>
				<find><![CDATA[		$sql_select = $sql_where_data = $sql_from = $sql_where = $order_by = '';]]></find>
				<action type="after-add"><![CDATA[		if (!class_exists('invite'))
		{
			include($phpbb_root_path . 'includes/functions_invite.' . $phpEx);
		}
		$user->add_lang('mods/info_acp_invite');

		$invitation = new invite();
		$ui = request_var('ui', '');
		$referral_mode = request_var('rm', 0);
		$search_ui = (!is_numeric($ui)) ? (int) $invitation->user_return_data(utf8_clean_string($ui), 'username_clean', 'user_id') : (int) $ui;

		if ($referral_mode)
		{
			$sql_where .= ($invitation->config['referral_search_allowed'] && $invitation->config['display_m_referrer'] && $search_ui) ? ' AND i.referrer_id = ' . $search_ui : '';
			$sql_where .= ($invitation->config['referral_search_allowed'] && $invitation->config['display_m_referrer'] && $search_ui) ? ' AND i.referrer_id <> u.user_id AND i.referral_id = u.user_id': '';
			$sql_from .= ($invitation->config['referral_search_allowed'] && $invitation->config['display_m_referrer'] && $search_ui) ? ', ' . INVITE_REFERRALS_TABLE . ' i ' : '';
		}
		else
		{
			$sql_where .= ($invitation->config['invite_search_allowed'] && $invitation->config['display_m_inviter'] && $search_ui) ? ' AND i.invite_user_id = ' . $search_ui : '';
			$sql_where .= ($invitation->config['invite_search_allowed'] && $invitation->config['display_m_inviter'] && $search_ui) ? ' AND i.invite_user_id <> u.user_id AND i.register_user_id = u.user_id AND i.register_key_used = 1': '';
			$sql_from .= ($invitation->config['invite_search_allowed'] && $invitation->config['display_m_inviter'] && $search_ui) ? ', ' . INVITE_LOG_TABLE . ' i ' : '';
		}

		$sort_key_text['referrer'] = $user->lang['DISPLAY_REFERRER'];
		$sort_key_sql['referrer'] = 'u.user_referrer_name';
		$sort_key_text['referrals'] = $user->lang['DISPLAY_REFERRALS'];
		$sort_key_sql['referrals'] = 'u.user_referrals';
		$sort_key_text['inviter'] = $user->lang['DISPLAY_INVITER'];
		$sort_key_sql['inviter'] = 'u.user_inviter_name';
		$sort_key_text['invite'] = $user->lang['DISPLAY_INVITE'];
		$sort_key_sql['invite'] = 'u.user_invitations';
		$sort_key_text['register'] = $user->lang['DISPLAY_REGISTER'];
		$sort_key_sql['register'] = 'u.user_registrations';
]]></action>
			</edit>
			<edit>
				<find><![CDATA[		$search_params = array('username', 'email', 'icq', 'aim', 'yahoo', 'msn', 'jabber', 'search_group_id', 'joined_select', 'active_select', 'count_select', 'joined', 'active', 'count', 'ip');]]></find>
				<inline-edit>
					<inline-find><![CDATA['ip']]></inline-find>
					<inline-action type="after-add"><![CDATA[, 'ui', 'invite', 'register', 'rm', 'referrals']]></inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[			$sql_where .= ($username) ? ' AND u.username_clean ' . $db->sql_like_expression(str_replace('*', $db->any_char, utf8_clean_string($username))) : '';]]></find>
				<action type="before-add"><![CDATA[			$invite = (request_var('invite', '') !== '') ? request_var('invite', 0) : '';
			$register = (request_var('register', '') !== '') ? request_var('register', 0) : '';
			$referrals = (request_var('referrals', '') !== '') ? request_var('referrals', 0) : '';
			$invite_select = request_var('invite_select', 'eq');
			$register_select = request_var('register_select', 'eq');
			$referrals_select = request_var('referrals_select', 'eq');

			$s_find_invite = '';
			foreach ($find_count as $key => $value)
			{
				$selected = ($invite_select == $key) ? ' selected="selected"' : '';
				$s_find_invite .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
			}
			$s_find_register = '';
			foreach ($find_count as $key => $value)
			{
				$selected = ($register_select == $key) ? ' selected="selected"' : '';
				$s_find_register .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
			}
			$s_find_referrals = '';
			foreach ($find_count as $key => $value)
			{
				$selected = ($referrals_select == $key) ? ' selected="selected"' : '';
				$s_find_referrals .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
			}

			$sql_where .= ($invitation->config['invite_search_allowed'] && $invitation->config['display_m_invite'] && is_numeric($invite) && isset($find_key_match[$invite_select])) ? ' AND u.user_invitations ' . $find_key_match[$invite_select] . ' ' . (int) $invite . ' ' : '';
			$sql_where .= ($invitation->config['invite_search_allowed'] && $invitation->config['display_m_register'] && is_numeric($register) && isset($find_key_match[$register_select])) ? ' AND u.user_registrations ' . $find_key_match[$register_select] . ' ' . (int) $register . ' ' : '';
			$sql_where .= ($invitation->config['referral_search_allowed'] && $invitation->config['display_m_referrals'] && is_numeric($referrals) && isset($find_key_match[$referrals_select])) ? ' AND u.user_referrals ' . $find_key_match[$referrals_select] . ' ' . (int) $referrals . ' ' : '';]]></action>
			</edit>
			<edit>
				<find><![CDATA[			'first_char'	=> array('first_char', ''),]]></find>
				<action type="after-add"><![CDATA[			'ui'			=> array('ui', '', true),
			'invite'		=> (request_var('invite', '') !== '') ? array('invite', 0) : array('invite', ''),
			'register'		=> (request_var('register', '') !== '') ? array('register', 0) : array('register', ''),
			'rm'			=> array('rm', 0, true),
			'referrals'		=> (request_var('referrals', '') !== '') ? array('referrals', 0) : array('referrals', ''),]]></action>
			</edit>
			<edit>
				<find><![CDATA[		$leaders_set = false;]]></find>
				<action type="after-add"><![CDATA[if ($ui)
		{
			if (!$search_ui)
			{
				$user_list = array();
			}
			else
			{
				$ui_info = $invitation->get_profile_info('', 'memberlist', $search_ui);
			}
			$total_users = sizeof($user_list);

			$template->assign_vars(array(
				'PAGE_TITLE_INVITE_SEARCH'	=> (isset($ui_info) && $invitation->config['invite_search_allowed']) ? sprintf($user->lang['PAGE_TITLE_INVITE_SEARCH'], $ui_info['username_full']) : '',
				'PAGE_TITLE_REFERRAL_SEARCH'=> (isset($ui_info) && $invitation->config['referral_search_allowed']) ? sprintf($user->lang['PAGE_TITLE_REFERRAL_SEARCH'], $ui_info['username_full']) : '',
				'S_INVITE_FILTER'			=> (isset($ui_info) && !$referral_mode) ? true : false,
				'S_REFERRAL_FILTER'			=> (isset($ui_info) && $referral_mode) ? true : false,
				'S_ENABLE_REFERRAL_FILTER'	=> ($invitation->config['referral_search_allowed']) ? $invitation->config['display_m_referrer'] : false,
				'S_ENABLE_INVITE_FILTER'	=> ($invitation->config['invite_search_allowed']) ? $invitation->config['display_m_inviter'] : false)
			);
		}
		if ($invitation->config['enable_invitation'])
		{
			$template->assign_vars(array(
				'INVITER'					=> (isset($ui)) ? ((is_numeric($ui)) ? $invitation->user_return_data($ui, 'user_id', 'username') : $ui) : '',
				'INVITE'					=> (isset($invite)) ? $invite : '',
				'REGISTER'					=> (isset($register)) ? $register : '',
				'S_INVITE_OPTIONS'			=> (isset($s_find_invite)) ? $s_find_invite : '',
				'S_REGISTER_OPTIONS'		=> (isset($s_find_register)) ? $s_find_register : '',
				'U_SORT_INVITER'			=> ($invitation->config['display_m_inviter']) ? $sort_url . '&amp;sk=inviter&amp;sd=' . (($sort_key == 'inviter' && $sort_dir == 'a') ? 'd' : 'a') : false,
				'U_SORT_INVITE'				=> ($invitation->config['display_m_invite']) ? $sort_url . '&amp;sk=invite&amp;sd=' . (($sort_key == 'invite' && $sort_dir == 'a') ? 'd' : 'a') : false,
				'U_SORT_REGISTER'			=> ($invitation->config['display_m_register']) ? $sort_url . '&amp;sk=register&amp;sd=' . (($sort_key == 'register' && $sort_dir == 'a') ? 'd' : 'a') : false,
				'S_INVITE_SEARCH_ALLOWED'	=> $invitation->config['invite_search_allowed'])
			);
		}
		if ($invitation->config['enable_referral'])
		{
			$template->assign_vars(array(
				'REFERRER'					=> (isset($ui)) ? ((is_numeric($ui)) ? $invitation->user_return_data($ui, 'user_id', 'username') : $ui) : '',
				'REFERRALS'					=> (isset($referrals)) ? $referrals : '',
				'S_REFERRALS_OPTIONS'		=> (isset($s_find_referrals)) ? $s_find_referrals : '',
				'U_SORT_REFERRER'			=> ($invitation->config['display_m_referrer']) ? $sort_url . '&amp;sk=referrer&amp;sd=' . (($sort_key == 'referrer' && $sort_dir == 'a') ? 'd' : 'a') : false,
				'U_SORT_REFERRALS'			=> ($invitation->config['display_m_referrals']) ? $sort_url . '&amp;sk=referrals&amp;sd=' . (($sort_key == 'referrals' && $sort_dir == 'a') ? 'd' : 'a') : false,
				'S_REFERRAL_SEARCH_ALLOWED'	=> $invitation->config['referral_search_allowed'])
			);
		}]]></action>
			</edit>
			<edit>
				<find><![CDATA[				if (isset($cp_row['row']) && sizeof($cp_row['row']))]]></find>
				<action type="before-add"><![CDATA[				$memberrow = $invitation->profile_fields($memberrow, $user_id);]]></action>
			</edit>
		</open>

		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[	if (isset($cp_row['row']) && sizeof($cp_row['row']))
	{
		$postrow = array_merge($postrow, $cp_row['row']);
	}]]></find>
				<action type="after-add"><![CDATA[	if (!class_exists('invite'))
	{
		include($phpbb_root_path . 'includes/functions_invite.' . $phpEx);
	}
	$invite	= new invite();
	$postrow = $invite->profile_fields($postrow, $poster_id);]]></action>
			</edit>

		</open>

		<open src="includes/constants.php">
			<comment lang="en">Please note that you have to use another digit for LOG_INVITE if 4 is already taken.</comment>
			<edit>
				<find><![CDATA[// Additional tables]]></find>
				<action type="after-add"><![CDATA[define('INVITE_CONFIG_TABLE',		$table_prefix . 'invite_config');
define('INVITE_LOG_TABLE',			$table_prefix . 'invite_log');
define('INVITE_REFERRALS_TABLE',	$table_prefix . 'invite_referrals');
define('LOG_INVITE', 				4);]]></action>
			</edit>
		</open>

		<open src="includes/functions.php">
			<edit>
				<find><![CDATA[		case 'critical':
			$sql_ary['log_type'] = LOG_CRITICAL;
		break;]]></find>
				<action type="after-add"><![CDATA[		case 'invite':
			$sql_ary['log_type'] = LOG_INVITE;
		break;]]></action>
			</edit>
			<edit>
				<find><![CDATA[	define('HEADER_INC', true);]]></find>
				<action type="after-add"><![CDATA[	if (!class_exists('invite'))
	{
		include($phpbb_root_path . 'includes/functions_invite.' . $phpEx);
	}
	$invite	= new invite();
	$invite->header_template();]]></action>
			</edit>
		</open>

		<open src="includes/functions_admin.php">
			<edit>
				<find><![CDATA[		case 'critical':
			$log_type = LOG_CRITICAL;
			$sql_forum = '';
		break;]]></find>
				<action type="after-add"><![CDATA[		case 'invite':
			$log_type = LOG_INVITE;
			$sql_forum = '';

			// Unfortunately we have to abuse $topic_id as $filter...
			$sql_forum .= ($topic_id == 'all') ? '' : 'AND l.log_operation LIKE "LOG_INVITE_' . strtoupper($topic_id) . '"';
			$sql_forum .= ($forum_id) ? 'AND l.user_id = ' . $forum_id : '';
		break;]]></action>
			</edit>
		</open>

		<open src="includes/ucp/ucp_register.php">
			<edit>
				<find><![CDATA[				$change_lang = '';
				$user_lang = $user->lang_name;
			}
		}]]></find>
				<action type="after-add"><![CDATA[		// Invitation and referral setup
		if (!class_exists('invite'))
		{
			include($phpbb_root_path . 'includes/functions_invite.' . $phpEx);
		}
		$user->add_lang('mods/info_ucp_invite');

		$invite			= new invite();
		$register_key	= request_var('key', '', true);
		$referrer		= request_var('referrer', '', true);
		$referrer_id	= (int) request_var('referrer_id', 0);
		
		// Check for cookies
		$cookie_key			= (isset($_COOKIE[$config['cookie_name'] . '_reg_key'])) ? $_COOKIE[$config['cookie_name'] . '_reg_key'] : '';
		$register_key 		= (!empty($cookie_key) && empty($register_key)) ? $cookie_key : $register_key;
		$cookie_referrer	= (isset($_COOKIE[$config['cookie_name'] . '_referrer'])) ? $_COOKIE[$config['cookie_name'] . '_referrer'] : '';
		$referrer			= (!empty($cookie_referrer) && empty($referrer)) ? $cookie_referrer : $referrer;
		$cookie_referrer_id	= (isset($_COOKIE[$config['cookie_name'] . '_referrer_id'])) ? $_COOKIE[$config['cookie_name'] . '_referrer_id'] : '';
		$referrer_id		= (!empty($cookie_referrer_id) && !$referrer_id) ? $cookie_referrer_id : $referrer_id;

		// URL appendix
		$url_key 		= (!empty($register_key)) ? "&amp;key={$register_key}" : '';
		$url_referrer	= (!empty($referrer)) ? "&amp;referrer={$referrer}" : '';
		$url_referrer  .= ($referrer_id) ? "&amp;referrer_id={$referrer_id}" : '';

		// Grab referral data from registration key
		if ($invite->config['enable_referral'] && $invite->config['enable_invitation'] && $invite->valid_key($register_key))
		{
			$referrer_id = $invite->get_referrer_from_key($register_key);
		}

		// Automatically enter referrer username if his id is given
		if (empty($referrer) && $referrer_id)
		{
			$referrer = $invite->user_return_data($referrer_id, 'user_id', 'username');
		}

		// We have to assign the registration key here because we want it to be kept even if the registration process is returned
		$template->assign_var('REGISTER_KEY', $register_key);]]></action>
			</edit>
			<edit>
				<find><![CDATA[			$add_coppa = ($coppa !== false) ? '&amp;coppa=' . $coppa : '';]]></find>
				<action type="after-add"><![CDATA[			// Abuse $add_lang var for our registration key and referral data
			$add_lang .= $url_key;
			$add_lang .= $url_referrer;

			// Set session cookies if desired
			if ($invite->config['set_cookie'] && $invite->valid_key($register_key))
			{
				$user->set_cookie('reg_key', $register_key, 0);
			}
			if ($invite->config['referral_cookie'])
			{
				if ($invite->user_exists($referrer))
				{
					$user->set_cookie('referrer', $referrer, 0);
				}
				if (!$referrer_id)
				{
					$user->set_cookie('referrer_id', $referrer_id, 0);
				}
			}]]></action>
			</edit>
			<edit>
				<find><![CDATA[			// DNSBL check]]></find>
				<action type="before-add"><![CDATA[			// Handle registration keys
			if ($invite->config['enable_invitation'])
			{
				if (!$invite->valid_key($register_key) && $invite->config['enable_key'] == 1)
				{
					if ($invite->config['enable_key'] == 1)
					{
						$error[] = $user->lang['REGISTER_KEY_INVALID'];
					}
					if ($invite->config['enable_key'] == 0)
					{
						$error[] = $user->lang['REGISTER_KEY_INVALID_OPTIONAL'];
					}
				}

				// Different account activation for registration keys?
				if ($invite->valid_key($register_key, false))
				{
					$config['require_activation'] = ($invite->config['invite_require_activation'] == 3) ? $config['require_activation'] : $invite->config['invite_require_activation'];
				}

				// Someone is trying to take the mickey out of us? Prevent abuse!
				if ($invite->invite_yourself($register_key))
				{
					$error[] = $user->lang['INVITE_YOURSELF'];
				}
				
				// Did the key expire?
				if ($invite->valid_key($register_key) && $invite->is_expired($register_key))
				{
					$error[] = $user->lang['REGISTER_KEY_EXPIRED'];
				}
			}
			
			// Referrals
			if ($invite->config['enable_referral'])
			{
				if ($invite->config['referral_require'] && empty($referrer) && !$referrer_id)
				{
					$error[] = $user->lang['REFERRER_REQUIRED'];
				}

				if (!empty($referrer) && !$invite->user_exists($referrer))
				{
					$error[] = $user->lang['REFERRER_NOT_EXISTENT'];
				}
			}]]></action>
			</edit>
			<edit>
				<find><![CDATA[				// Register user...
				$user_id = user_add($user_row, $cp_data);]]></find>
				<action type="after-add"><![CDATA[				if ($invite->config['enable_referral'])
				{
					$invite->add_referral($referrer, $referrer_id, $user_id, $invite->valid_key($register_key));
				}

				if ($invite->config['enable_invitation'])
				{
					$invite->register_user($register_key, $user_id);
				}]]></action>
			</edit>
			<edit>
				<find><![CDATA[			'S_UCP_ACTION'		=> append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=register'),]]></find>
				<action type="replace-with"><![CDATA[			'S_UCP_ACTION'		=> append_sid("{$phpbb_root_path}ucp.$phpEx", '&amp;mode=register' . $url_key . $url_referrer),

			'REGISTER_KEY'				=> $register_key,
			'REFERRER'					=> $referrer,
			'REFERRER_ID'				=> $referrer_id,
			'S_REGISTER_KEY_EMPTY'		=> (empty($register_key) || !$register_key) ? true : false,
			'S_DISPLAY_REGISTER_KEY'	=> ($invite->config['enable_invitation']) ? (($invite->valid_key($register_key) && $invite->config['autohide_valid_key']) ? false : (($invite->config['display_registration']) ? true : false)) : false,
			'S_ENABLE_KEY_OPTIONAL'		=> ($invite->config['enable_key'] == 0) ? true : false,
			'S_ENABLE_REFERRAL_AS'		=> ($invite->config['referral_as']) ? true : false,
			'S_DISPLAY_REFERRAL'		=> ($invite->config['enable_referral']) ? (($invite->config['referral_autohide']) ? ((!empty($referrer) || !$referrer_id) ? false : true) : true) : false,
			'S_DISABLE_REFERRAL'		=> ($invite->config['referral_autodisable'] && !empty($referrer)) ? true : false,]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/template/memberlist_body.html">
			<edit>
				<find><![CDATA[<!-- ELSE -->
	<!-- INCLUDE overall_header.html -->
	<form method="post" action="{S_MODE_ACTION}">

<!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[<!-- Calculate correct colspan -->
<!-- IF U_SORT_ACTIVE or S_VIEWONLINE -->
<!-- DEFINE $COLSPAN = 5 -->
<!-- ELSE -->
<!-- DEFINE $COLSPAN = 4 -->
<!-- ENDIF -->
<!-- IF U_SORT_INVITER --><!-- DEFINE $COLSPAN = $COLSPAN + 1 --><!-- ENDIF -->
<!-- IF U_SORT_INVITE --><!-- DEFINE $COLSPAN = $COLSPAN + 1 --><!-- ENDIF -->
<!-- IF U_SORT_REGISTER --><!-- DEFINE $COLSPAN = $COLSPAN + 1 --><!-- ENDIF -->
<!-- IF U_SORT_REFERRER --><!-- DEFINE $COLSPAN = $COLSPAN + 1 --><!-- ENDIF -->
<!-- IF U_SORT_REFERRALS --><!-- DEFINE $COLSPAN = $COLSPAN + 1 --><!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[		<h2 class="solo">{PAGE_TITLE}<!-- IF SEARCH_WORDS -->: <a href="{U_SEARCH_WORDS}">{SEARCH_WORDS}</a><!-- ENDIF --></h2>]]></find>
				<action type="replace-with"><![CDATA[		<h2 class="solo"><!-- IF S_ENABLE_INVITE_FILTER and S_INVITE_FILTER -->{PAGE_TITLE_INVITE_SEARCH}<!-- ELSEIF S_ENABLE_REFERRAL_FILTER and S_REFERRAL_FILTER -->{PAGE_TITLE_REFERRAL_SEARCH}<!-- ELSE -->{PAGE_TITLE}<!-- ENDIF --><!-- IF SEARCH_WORDS -->: <a href="{U_SEARCH_WORDS}">{SEARCH_WORDS}</a><!-- ENDIF --></h2>]]></action>
			</edit>
			<edit>
				<find><![CDATA[			<th class="name"><span class="rank-img"><a href="{U_SORT_RANK}">{L_RANK}</a></span><a href="{U_SORT_USERNAME}"><!-- IF S_SHOW_GROUP and .memberrow -->{L_GROUP_LEADER}<!-- ELSE -->{L_USERNAME}<!-- ENDIF --></a></th>]]></find>
				<action type="after-add"><![CDATA[			<!-- IF U_SORT_INVITER --><th class="<!-- IF not U_SORT_INVITE and not U_SORT_REGISTER -->joined<!-- ELSE -->posts<!-- ENDIF -->"><a href="{U_SORT_INVITER}#memberlist">{L_DISPLAY_INVITER}</a></th><!-- ENDIF -->
			<!-- IF U_SORT_REFERRER --><th class="<!-- IF not U_SORT_REFERRALS -->joined<!-- ELSE -->posts<!-- ENDIF -->"><a href="{U_SORT_REFERRER}#memberlist">{L_DISPLAY_REFERRER}</a></th><!-- ENDIF -->
			<!-- IF U_SORT_INVITE --><th class="posts"><a href="{U_SORT_INVITE}#memberlist">{L_DISPLAY_INVITE}</a></th><!-- ENDIF -->
			<!-- IF U_SORT_REGISTER --><th class="posts"><a href="{U_SORT_REGISTER}">{L_DISPLAY_REGISTER}</a></th><!-- ENDIF -->
			<!-- IF U_SORT_REFERRALS --><th class="posts"><a href="{U_SORT_REFERRALS}">{L_DISPLAY_REFERRALS}</a></th><!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[					<td colspan="<!-- IF U_SORT_ACTIVE -->5<!-- ELSE -->4<!-- ENDIF -->">&nbsp;</td>]]></find>
				<action type="replace-with"><![CDATA[					<td colspan="{$COLSPAN}">&nbsp;</td>]]></action>
			</edit>
			<edit>
				<find><![CDATA[	<!-- IF not S_LEADERS_SET -->
		<th class="name"><span class="rank-img"><a href="{U_SORT_RANK}">{L_RANK}</a></span><a href="{U_SORT_USERNAME}"><!-- IF S_SHOW_GROUP -->{L_GROUP_MEMBERS}<!-- ELSE -->{L_USERNAME}<!-- ENDIF --></a></th>]]></find>
				<action type="after-add"><![CDATA[			<!-- IF U_SORT_INVITER --><th class="<!-- IF not U_SORT_INVITE and not U_SORT_REGISTER -->joined<!-- ELSE -->posts<!-- ENDIF -->"><a href="{U_SORT_INVITER}#memberlist">{L_DISPLAY_INVITER}</a></th><!-- ENDIF -->
			<!-- IF U_SORT_REFERRER --><th class="<!-- IF not U_SORT_REFERRALS -->joined<!-- ELSE -->posts<!-- ENDIF -->"><a href="{U_SORT_REFERRER}#memberlist">{L_DISPLAY_REFERRER}</a></th><!-- ENDIF -->
			<!-- IF U_SORT_INVITE --><th class="posts"><a href="{U_SORT_INVITE}#memberlist">{L_DISPLAY_INVITE}</a></th><!-- ENDIF -->
			<!-- IF U_SORT_REGISTER --><th class="posts"><a href="{U_SORT_REGISTER}">{L_DISPLAY_REGISTER}</a><!-- ENDIF -->
			<!-- IF U_SORT_REFERRALS --><th class="posts"><a href="{U_SORT_REFERRALS}">{L_DISPLAY_REFERRALS}</a></th><!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[	<!-- ELSEIF S_SHOW_GROUP -->
		<th class="name">{L_GROUP_MEMBERS}</th>]]></find>
				<action type="after-add"><![CDATA[		<!-- IF U_SORT_INVITER --><th class="<!-- IF not U_SORT_INVITE and not U_SORT_REGISTER -->joined<!-- ELSE -->posts<!-- ENDIF -->"><a href="{U_SORT_INVITER}#memberlist">{L_DISPLAY_INVITER}</a></th><!-- ENDIF -->
		<!-- IF U_SORT_REFERRER --><th class="<!-- IF not U_SORT_REFERRALS -->joined<!-- ELSE -->posts<!-- ENDIF -->"><a href="{U_SORT_REFERRER}#memberlist">{L_DISPLAY_REFERRER}</a></th><!-- ENDIF -->
		<!-- IF U_SORT_INVITE --><th class="posts"><a href="{U_SORT_INVITE}#memberlist">{L_DISPLAY_INVITE}</a></th><!-- ENDIF -->
		<!-- IF U_SORT_REGISTER --><th class="posts"><a href="{U_SORT_REGISTER}">{L_DISPLAY_REGISTER}</a><!-- ENDIF -->
		<!-- IF U_SORT_REFERRALS --><th class="posts"><a href="{U_SORT_REFERRALS}">{L_DISPLAY_REFERRALS}</a></th><!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[		<td><!-- IF memberrow.RANK_IMG --><span class="rank-img">{memberrow.RANK_IMG}</span><!-- ELSE --><span class="rank-img">{memberrow.RANK_TITLE}</span><!-- ENDIF --><!-- IF S_IN_SEARCH_POPUP and not S_SELECT_SINGLE --><input type="checkbox" name="user" value="{memberrow.USERNAME}" /> <!-- ENDIF -->{memberrow.USERNAME_FULL}<!-- IF S_SELECT_SINGLE --><br />[&nbsp;<a href="#" onclick="insert_single('{memberrow.A_USERNAME}'); return false;">{L_SELECT}</a>&nbsp;]<!-- ENDIF --></td>]]></find>
				<action type="after-add"><![CDATA[		<!-- IF U_SORT_INVITER --><td class="<!-- IF not U_SORT_INVITE and not U_SORT_REGISTER -->joined<!-- ELSE -->posts<!-- ENDIF -->"><!-- IF memberrow.POSTER_INVITE_INVITER -->{memberrow.POSTER_INVITE_INVITER}<!-- ENDIF --></td><!-- ENDIF -->
		<!-- IF U_SORT_REFERRER --><td class="<!-- IF not U_SORT_REFERRER -->joined<!-- ELSE -->posts<!-- ENDIF -->"><!-- IF memberrow.POSTER_REFERRER -->{memberrow.POSTER_REFERRER}<!-- ENDIF --></td><!-- ENDIF -->
		<!-- IF U_SORT_INVITE --><td class="posts">{memberrow.POSTER_INVITE_INVITE}</td><!-- ENDIF -->
		<!-- IF U_SORT_REGISTER --><td class="posts">{memberrow.POSTER_INVITE_REGISTER}</td><!-- ENDIF -->
		<!-- IF U_SORT_REFERRALS --><td class="posts">{memberrow.POSTER_REFERRALS}</a></td><!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[		<td colspan="<!-- IF S_VIEWONLINE -->5<!-- ELSE -->4<!-- ENDIF -->">{L_NO_MEMBERS}</td>]]></find>
				<action type="replace-with"><![CDATA[		<td colspan="{$COLSPAN}">{L_NO_MEMBERS}</td>]]></action>
			</edit>
		</open>
			
		<open src="styles/prosilver/template/memberlist_search.html">
			<edit>
				<find><![CDATA[	<dl>
		<dt><label for="username">{L_USERNAME}:</label></dt>
		<dd><input type="text" name="username" id="username" value="{USERNAME}" class="inputbox" /></dd>
	</dl>]]></find>
				<action type="after-add"><![CDATA[	<!-- IF S_REFERRAL_SEARCH_ALLOWED and U_SORT_REFERRER -->
		<dl>
			<dt><label for="uir">{L_DISPLAY_REFERRER}:</label></dt>
			<dd><input type="text" name="uir" id="uir" value="{REFERRER}" class="inputbox" /></dd>
		</dl>
	<!-- ELSEIF S_INVITE_SEARCH_ALLOWED and U_SORT_INVITER -->
		<dl>
			<dt><label for="ui">{L_DISPLAY_INVITER}:</label></dt>
			<dd><input type="text" name="ui" id="ui" value="{INVITER}" class="inputbox" /></dd>
		</dl>
	<!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[	<dl>
		<dt><label for="count">{L_POSTS}:</label></dt>
		<dd><select name="count_select">{S_COUNT_OPTIONS}</select> <input class="inputbox medium" type="text" name="count" id="count" value="{COUNT}" /></dd>
	</dl>]]></find>
				<action type="after-add"><![CDATA[	<!-- IF S_INVITE_SEARCH_ALLOWED and U_SORT_INVITE -->
		<dl>
			<dt><label for="invite">{L_DISPLAY_INVITE}:</label></dt>
			<dd><select name="invite_select">{S_INVITE_OPTIONS}</select> <input class="inputbox medium" type="text" name="invite" id="invite" value="{INVITE}" /></dd>
		</dl>
	<!-- ENDIF -->
	<!-- IF S_INVITE_SEARCH_ALLOWED and U_SORT_REGISTER -->
		<dl>
			<dt><label for="register">{L_DISPLAY_REGISTER}:</label></dt>
			<dd><select name="register_select">{S_REGISTER_OPTIONS}</select> <input class="inputbox medium" type="text" name="register" id="register" value="{REGISTER}" /></dd>
		</dl>
	<!-- ENDIF -->
	<!-- IF S_REFERRAL_SEARCH_ALLOWED and U_SORT_REFERRALS -->
		<dl>
			<dt><label for="referrals">{L_DISPLAY_REFERRALS}:</label></dt>
			<dd><select name="referrals_select">{S_REFERRALS_OPTIONS}</select> <input class="inputbox medium" type="text" name="referrals" id="referrals" value="{REFERRALS}" /></dd>
		</dl>
	<!-- ENDIF -->]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/template/memberlist_view.html">
			<edit>
				<find><![CDATA[				<!-- IF U_ADD_FOE -->
					<dt>&nbsp;</dt> <dd><a href="{U_ADD_FOE}"><strong>{L_ADD_FOE}</strong></a></dd>
				<!-- ENDIF -->
			<!-- ENDIF -->
		<!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[		<!-- IF S_P_DISPLAY_REFERRAL_LINK --><dt>{L_REFERRAL_LINK}:</dt> <dd>{U_REFERRAL_LINK}</dd><!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[			<dt>{L_VISITED}:</dt> <dd>{VISITED}</dd>]]></find>
				<action type="after-add"><![CDATA[			<!-- IF POSTER_INVITE_INVITER and S_P_DISPLAY_INVITER --><dt>{L_DISPLAY_INVITER}:</dt> <dd>{POSTER_INVITE_INVITER}</dd><!-- ENDIF -->
			<!-- IF POSTER_REFERRER and S_P_DISPLAY_REFERRER --><dt>{L_DISPLAY_REFERRER}:</dt> <dd>{POSTER_REFERRER}</dd><!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[		</dl>
	</div>
	<span class="corners-bottom"><span></span></span></div>]]></find>
				<action type="before-add"><![CDATA[			<!-- IF S_P_DISPLAY_INVITE -->
				<dt>{L_DISPLAY_INVITE}:</dt> <dd>{POSTER_INVITE_INVITE} <!-- IF U_USER_ADMIN --> [ <a href="{U_USER_ADMIN_INVITATIONS}">{L_USER_ADMIN_INVITATIONS}</a> ]<!-- ENDIF -->
				<!-- IF INVITATIONS_PCT --><br />({INVITATIONS_PCT} / {INVITATIONS_DAY})<!-- ENDIF --></dd>
			<!-- ENDIF -->
			<!-- IF S_P_DISPLAY_REGISTER -->
				<dt>{L_DISPLAY_REGISTER}:</dt> <dd>{POSTER_INVITE_REGISTER} <!-- IF S_DISPLAY_REGISTRATION_SEARCH -->| <strong><a href="{U_SEARCH_REGISTRATIONS}">{L_SEARCH_USER_REGISTRATIONS}</a></strong><!-- ENDIF -->
				<!-- IF U_USER_ADMIN --><!-- IF S_DISPLAY_REGISTRATION_SEARCH --><br /><!-- ENDIF -->[ <a href="{U_USER_ADMIN_REGISTRATIONS}">{L_USER_ADMIN_REGISTRATIONS}</a> ]<!-- ENDIF -->
				<!-- IF REGISTRATIONS_PCT --><br />({REGISTRATIONS_PCT} / {REGISTRATIONS_DAY} / {REGISTRATIONS_SUCCESS_RATE})<!-- ENDIF --></dd>
			<!-- ENDIF -->
			<!-- IF S_P_DISPLAY_REFERRALS -->
				<dt>{L_DISPLAY_REFERRALS}:</dt> <dd>{POSTER_REFERRALS} <!-- IF S_DISPLAY_REFERRALS_SEARCH -->| <strong><a href="{U_SEARCH_REFERRALS}">{L_SEARCH_USER_REFERRALS}</a></strong><!-- ENDIF -->
				<!-- IF U_USER_ADMIN --><!-- IF S_DISPLAY_REFERRALS_SEARCH --><br /><!-- ENDIF -->[ <a href="{U_USER_ADMIN_REFERRALS}">{L_USER_ADMIN_REFERRALS}</a> ]<!-- ENDIF -->
				<!-- IF REFERRALS_PCT --><br />({REFERRALS_PCT} / {REFERRALS_DAY})<!-- ENDIF --></dd>
			<!-- ENDIF -->]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/template/overall_header.html">
			<edit>
				<find><![CDATA[<!-- IF S_CONTENT_DIRECTION eq 'rtl' -->
	<link href="{T_THEME_PATH}/bidi.css" rel="stylesheet" type="text/css" media="screen, projection" />
<!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[<!-- IF S_ENABLE_REFERRAL_AS and S_DISPLAY_REFERRAL -->
	<script type="text/javascript" src="{T_SUPER_TEMPLATE_PATH}/autosuggest.js"></script>
	<link rel="stylesheet" href="{T_THEME_PATH}/autosuggest.css" type="text/css" media="screen" charset="utf-8" />
<!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[					<!-- IF U_RESTORE_PERMISSIONS --> &bull;
					<a href="{U_RESTORE_PERMISSIONS}">{L_RESTORE_PERMISSIONS}</a>
					<!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[					<!-- IF S_DISPLAY_INVITE_LEFT --> &bull;
					<a href="{U_INVITE_A_FRIEND}">{L_INVITE}</a>
					<!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[				<!-- IF not S_IS_BOT -->]]></find>
				<action type="after-add"><![CDATA[					<!-- IF S_DISPLAY_INVITE_RIGHT --><li class="icon-invitation"><a href="{U_INVITE_A_FRIEND}" title="{L_INVITATION_EXPLAIN}">{L_INVITATION}</a></li><!-- ENDIF -->]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/template/ucp_register.html">
			<edit>
				<find><![CDATA[	<dl>
		<dt><label for="password_confirm">{L_CONFIRM_PASSWORD}:</label></dt>
		<dd><input type="password" tabindex="5" name="password_confirm" id="password_confirm" size="25" value="{PASSWORD_CONFIRM}" class="inputbox autowidth" title="{L_CONFIRM_PASSWORD}" /></dd>
	</dl>]]></find>
				<action type="after-add"><![CDATA[	<!-- IF S_DISPLAY_REGISTER_KEY or S_DISPLAY_REFERRAL --><hr /><!-- ENDIF -->
	<!-- IF S_DISPLAY_REGISTER_KEY -->
		<dl>
			<dt><label for="key">{L_REGISTER_KEY}:<!-- IF S_ENABLE_KEY_OPTIONAL --> ({L_OPTIONAL})<!-- ENDIF --></label><br /><span>{L_REGISTER_KEY_EXPLAIN}</span></dt>
			<dd><input type="text" name="key" id="key" size="25" value="{REGISTER_KEY}" class="inputbox autowidth" title="{L_REGISTER_KEY}" /></dd>
		</dl>
	<!-- ENDIF -->
	<!-- IF S_DISPLAY_REFERRAL -->
		<dl>
			<dt><label for="referrer">{L_REFERRED_BY}:</label><br /><span>{L_REFERRED_BY_EXPLAIN}</span></dt>
			<dd>
				<!-- IF not S_DISABLE_REFERRAL -->
					<input type="text" name="referrer" id="referrer" size="25" value="{REFERRER}" class="inputbox autowidth" title="{L_REFERRED_BY}" />
				<!-- ELSE -->
					<strong>{REFERRER}</strong>
				<!-- ENDIF -->
				<input type="hidden" name="referrer_id" id="referrer_id" value="{REFERRER_ID}" /></dd>
		</dl>
	<!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[<!-- INCLUDE overall_footer.html -->]]></find>
				<action type="before-add"><![CDATA[<!-- IF S_ENABLE_REFERRAL_AS and S_DISPLAY_REFERRAL -->
<script type="text/javascript">
	/**
	* Ajax autosuggest
	*/
	var options = {
		script:"{ROOT_PATH}referral_as.php?ajax=true&json=true&",
		varname:"input",
		json:true,
		shownoresults:false,
		callback: function (obj) { document.getElementById('referrer_id').value = obj.id; }
	};
	var as_json = new bsn.AutoSuggest('referrer', options);
</script>
<!-- ENDIF -->]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/template/viewtopic_body.html">
			<edit>
				<find><![CDATA[		<!-- IF postrow.POSTER_FROM --><dd><strong>{L_LOCATION}:</strong> {postrow.POSTER_FROM}</dd><!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[		<!-- IF postrow.POSTER_INVITE_INVITER and S_T_DISPLAY_INVITER --><dd><strong>{L_DISPLAY_INVITER}:</strong> {postrow.POSTER_INVITE_INVITER}</dd><!-- ENDIF -->
		<!-- IF postrow.POSTER_REFERRER and S_T_DISPLAY_REFERRER --><dd><strong>{L_DISPLAY_REFERRER}:</strong> {postrow.POSTER_REFERRER}</dd><!-- ENDIF -->
		<!-- IF S_T_DISPLAY_INVITE or S_T_DISPLAY_REGISTER or S_T_DISPLAY_REFERRALS --><br /><!-- ENDIF -->
		<!-- IF S_T_DISPLAY_INVITE --><dd><strong>{L_DISPLAY_INVITE}:</strong> {postrow.POSTER_INVITE_INVITE}</dd><!-- ENDIF -->
		<!-- IF S_T_DISPLAY_REGISTER --><dd><strong>{L_DISPLAY_REGISTER}:</strong> {postrow.POSTER_INVITE_REGISTER}</dd><!-- ENDIF -->
		<!-- IF S_T_DISPLAY_REFERRALS --><dd><strong>{L_DISPLAY_REFERRALS}:</strong> {postrow.POSTER_REFERRALS}</dd><!-- ENDIF -->]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/theme/bidi.css">
			<edit>
				<find><![CDATA[/* Icon images
---------------------------------------- */
.rtl .sitehome, .rtl .icon-faq, .rtl .icon-members, .rtl .icon-home, .rtl .icon-ucp, .rtl .icon-register, .rtl .icon-logout,]]></find>
				<inline-edit>
					<inline-find><![CDATA[.rtl .sitehome,]]></inline-find>
					<inline-action type="after-add"><![CDATA[.rtl .icon-invitation,]]></inline-action>
				</inline-edit>
			</edit>
		</open>

		<open src="styles/prosilver/theme/buttons.css">
			<edit>
				<find><![CDATA[/* Icon images
---------------------------------------- */
.sitehome, .icon-faq, .icon-members, .icon-home, .icon-ucp, .icon-register, .icon-logout,]]></find>
				<inline-edit>
					<inline-find><![CDATA[.sitehome,]]></inline-find>
					<inline-action type="after-add"><![CDATA[.icon-invitation,]]></inline-action>
				</inline-edit>
			</edit>
		</open>

		<open src="styles/prosilver/theme/colours.css">
			<edit>
				<find><![CDATA[.sitehome						{ background-image: url("{T_THEME_PATH}/images/icon_home.gif"); }]]></find>
				<action type="after-add"><![CDATA[.icon-invitation				{ background-image: url("{T_THEME_PATH}/images/icon_invitation.gif"); }]]></action>
			</edit>
		</open>

		<php-installer>install/install_invite.php</php-installer>

		<diy-instructions lang="en">When you are done with the file changes, please run the installation file at
BOARD_URL/install/install_invite.php
(If you are using AutoMOD 1.0, you can follow the installer link above)

Delete the 'install' folder afterwards, go to your Administrator Control Panel
and be sure that the settings and permissions added during the installation are as desired. Have fun.

Note:
You might want to install the templates for subsilver2 style or another language package as well.
Related instructions are included in the contrib/templates or contrib/languages folder.
		</diy-instructions>
	</action-group>
</mod>